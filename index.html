<!DOCTYPE html>
<html>
<head>
<title>How to make HTML 5 Games</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">


<script type="text/javascript">

window.onload = function() { 

test_collision_between_rectangles = function(rect1, rect2) { // Returns true if collinding and false if not colliding
	return rect1.x <= rect2.x + rect2.width
	&& rect2.x <= rect1.x + rect1.width
	&& rect1.y <= rect2.y + rect2.height
	&& rect2.y <= rect1.y + rect1.height;
}

is_position_out_of_bounds = function() {
	
}

entity = function(type, id, x, y, spd_x, spd_y, width, height, colour) {
	var self = {
		type: type,
		id: id,
		x: x,
		y: y,
		spd_x: spd_x,
		spd_y: spd_y,
		width: width,
		height: height,
		colour: colour
	};
	self.update = function() {
		self.update_entity_position();
		self.draw_entity();
	}

	self.update_entity_position = function() {
		if(self.type == "player") {
			if(self.up_key) 
				self.y -= 10;
			if(self.down_key) 
				self.y += 10;
			if(self.left_key) 
				self.x -= 10;
			if(self.right_key) 
				self.x += 10;

			if(self.x < self.width / 2)
				self.x = self.width / 2;
			if(self.x > CANVAS_WIDTH - self.width / 2)
				self.x = CANVAS_WIDTH - self.width / 2;
			if(self.y < self.height / 2)
				self.y = self.height / 2;
			if(self.y > CANVAS_HEIGHT - self.height / 2)
				self.y = CANVAS_HEIGHT - self.height / 2;
		}
		else {
			self.y += self.spd_y;
			self.x += self.spd_x;

			if(self.x <= 0 || self.x >= CANVAS_WIDTH) {
				self.spd_x = -self.spd_x;
			}

			if(self.y <= 0 || self.y >= CANVAS_HEIGHT) {
				self.spd_y = -self.spd_y;
			}
		}
	}

	self.draw_entity = function() {
		ctx.save();
		ctx.fillStyle = self.colour;
		ctx.fillRect(self.x - self.width / 2, self.y - self.height / 2, self.width, self.height);
		ctx.restore();
	}	

	self.get_distance_between_entities = function(entity2) {
		var vx = self.x - entity2.x;
		var vy = self.y -entity2.y;
		return Math.sqrt(vx * vx + vy * vy);
	}

	self.test_collision = function(entity2) {
		var rect1 = {
			x: self.x - self.width / 2,
			y: self.y - self.height / 2, // Dont understand why he made these half values by doing - half width,
			width: self.width,
			height: self.height
		}

		var rect2 = {
			x: entity2.x - entity2.width / 2,  // Dont understand why he made these half values by doing - half width,
			y: entity2.y - entity2.height / 2, 
			width: entity2.width,
			height: entity2.height
		}
		return test_collision_between_rectangles(rect1, rect2);
	}

	return self;
}

create_player = function() {
// Player
	var self = entity("player", "my_id", 250, 250, 5, 5, 20, 20, "green");

	self.hp = 10;
	self.attack_spd = 1;
	self.attack_counter = 0;
	self.up_key = false;
	self.down_key = false;
	self.left_key = false;
	self.right_key = false;
	self.aim_angle = 0;

	player = self
}

enemy = function(x, y, spd_x, spd_y, id, width, height) {
	// Enemy3
	var self = entity("enemy", id, x, y, spd_x, spd_y, width, height, "red");

	self.aim_angle = 0;
	self.attack_spd = 0;
	self.attack_counter = 0;

	enemy_list[id] = self;
}

upgrade = function(x, y, spd_x, spd_y, id, width, height, category, colour) {
	// Enemy3
	var self = entity("upgrade", id, x, y, spd_x, spd_y, width, height, colour);

	self.category = category

	upgrade_list[id] = self;
}

bullet = function(x, y, spd_x, spd_y, id, width, height) {
	// Enemy3
	var self = entity("bullet", id, x, y, spd_x, spd_y, width, height, "black")

	self.timer = 0;

	bullet_list[id] = self;
}

document.onmousemove = function(mouse) {

	var mouse_x = mouse.clientX - document.getElementById("canvas").getBoundingClientRect().left;
	var mouse_y = mouse.clientY - document.getElementById("canvas").getBoundingClientRect().top;

	mouse_x -= player.x;
	mouse_y -= player.y;

	player.aim_angle = Math.atan2(mouse_y, mouse_x) / Math.PI * 180;
	
}

clear_canvas = function() {
	ctx.clearRect(0, 0, 640, 480);
}

draw_score = function() {
	ctx.fillText("Health: " + player.hp, 0, 30);
	ctx.fillText("Score: " + score, 100, 30);
}

generate_enemy = function() {
	// Math.random() generates a number between 0 and 1
	var x = Math.random() * CANVAS_WIDTH;
	var y = Math.random() * CANVAS_HEIGHT;
	var width = 10 + Math.random() * 40;
	var height = 10 + Math.random() * 40;
	var id = Math.random();
	var spd_x = 5 + Math.random() * 2;
	var spd_y = 5 + Math.random() * 2

	enemy(x, y, spd_x, spd_y, id, width, height);
}

generate_upgrade = function() {
	// Math.random() generates a number between 0 and 1
	var x = Math.random() * CANVAS_WIDTH;
	var y = Math.random() * CANVAS_HEIGHT;
	var width = 10;
	var height = 10;
	var id = Math.random();
	var spd_x = 0;
	var spd_y = 0;

	if(Math.random() < 0.3) {
		var category = "attack_spd";
		var colour = "green";
	}

	else {
		var category = "score";
		var colour = "orange";
	}

	upgrade(x, y, spd_x, spd_y, id, width, height, category, colour);
}

generate_bullet = function(actor, overwrite_angle) {
	// Math.random() generates a number between 0 and 1
	var x = actor.x;
	var y = actor.y;
	var width = 10;
	var height = 10;
	var id = Math.random();
	var angle = actor.aim_angle;

	if(overwrite_angle !== undefined) 
		angle = overwrite_angle;

	var spd_x = Math.cos(angle / 180 * Math.PI) * 5;
	var spd_y = Math.sin(angle / 180 * Math.PI) * 5;

	bullet(x, y, spd_x, spd_y, id, width, height);
}

start_new_game = function() {
	// Restart score counter
	time_game_started = Date.now();
	player.hp = 10;
	score = 0;

	// Clear enemies then create them
	enemy_list = {};
	upgrade_list = {};
	bullet_list = {};
	generate_enemy();
	generate_enemy();
	generate_enemy();
}

document.onclick = function(mouse) {
	if(player.attack_counter > 25) {
		generate_bullet(player);
		player.attack_counter = 0;
	}
}

fire_bullet = function(actor) {
	if(actor.attack_counter > 25) {
		generate_bullet(actor);
		actor.attack_counter = 0;
	}
}

fire_special = function(actor) {
	if(actor.attack_counter > 50) {
			generate_bullet(player, player.aim_angle -3);
			generate_bullet(player, player.aim_angle);
			generate_bullet(player, player.aim_angle +3);
		actor.attack_counter = 0;
	}
	mouse.preventDefault();
}

document.oncontextmenu = function(mouse) { // on right click
	if(player.attack_counter > 50) {
			generate_bullet(player, player.aim_angle -3);
			generate_bullet(player, player.aim_angle);
			generate_bullet(player, player.aim_angle +3);
		player.attack_counter = 0;
	}
	mouse.preventDefault();
}

document.onkeydown = function(event) {
	if(event.keyCode === 87) // w
		player.up_key = true;
	else if(event.keyCode === 83) //s
		player.down_key = true;
	else if(event.keyCode === 65) // a
		player.left_key = true;
	else if(event.keyCode === 68) // d
		player.right_key = true;
}

document.onkeyup = function(event) {
	if(event.keyCode === 87)
		player.up_key = false;
	else if(event.keyCode === 83)
		player.down_key = false;
	else if(event.keyCode === 65)
		player.left_key = false;
	else if(event.keyCode === 68)
		player.right_key = false;
}

update_canvas = function() {
	clear_canvas();
	frame_count++;
	score++;

	if(frame_count % 100 === 0)
		generate_enemy();

	if(frame_count % 100 === 0)
		generate_upgrade();

	player.attack_counter += player.attack_spd;

	for(var key in bullet_list) {
		bullet_list[key].update();

		bullet_list[key].timer++;

		if(bullet_list[key].timer > 100) {
			delete bullet_list[key];
			continue;
		}

		for(var key2 in enemy_list) {

			var is_colliding = bullet_list[key].test_collision(enemy_list[key2]);
			if(is_colliding) {
				delete bullet_list[key];
				delete enemy_list[key2];
				break;
			}
		}
	}

	for(var key in upgrade_list) {
		upgrade_list[key].update();

		var is_colliding = player.test_collision(upgrade_list[key]);
		if(is_colliding) {
			if(upgrade_list[key].category == "attack_spd") {
				player.attack_spd = 3;
			}
			else {
				score += 1000;
			}
			delete upgrade_list[key];
		}
	}

	for(var key in enemy_list) {
		enemy_list[key].update();	

		var is_colliding = player.test_collision(enemy_list[key]);
		if(is_colliding) {
			console.log("Player Collided");
			player.hp -= 1;
		}
	}

	if(player.hp <= 0) {
		var time_survived = Date.now() - time_game_started;
		console.log("Your score is: " + time_survived + "ms");
	
		start_new_game();
	}

	player.update();
	draw_score();
}

/////////////////////////////////////////////////////////////

var ctx = document.getElementById("canvas").getContext("2d");

ctx.font = "20px Arial";

var message = "Hit Wall!";

var CANVAS_HEIGHT = 480;
var CANVAS_WIDTH = 640;
var time_game_started = Date.now(); // current time
var player;

var frame_count = 0;
var score = 0;

var enemy_list = {};
var upgrade_list = {};
var bullet_list = {};
create_player();
start_new_game();

setInterval(update_canvas, 25);

}; // End of onload

</script>
</head>

<body>
<canvas id="canvas" width="640" height="480"></canvas>
</body>
</html>